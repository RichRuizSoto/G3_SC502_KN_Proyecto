<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Editar Experiencia - Turismo Comunitario</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/layout.css" />
    <link rel="stylesheet" href="/static/css/publicar.css" />
  </head>
  
  <body>
    <div id="header-placeholder"></div>
    <script src="/static/js/header.js"></script>

    <main class="page-content">
      <section class="publish-container">
        <header class="publish-header">
          <h2>‚úèÔ∏è Editar Experiencia Existente</h2>
          <p>
            Modifica los detalles y guarda los cambios para actualizar la
            experiencia de tu comunidad.
          </p>
        </header>

        <form id="editForm" class="publish-form" enctype="multipart/form-data">

          <!-- FIELDSET 1: INFORMACI√ìN ESENCIAL -->
          <fieldset class="form-section">
            <legend>Informaci√≥n B√°sica del Evento</legend>

            <!-- T√çTULO -->
            <div class="form-group">
              <label for="titulo">T√≠tulo de la Experiencia</label>
              <input type="text" id="titulo" name="titulo" required />
            </div>

            <!-- UBICACI√ìN -->
            <div class="form-group">
              <label for="ubicacion">Ubicaci√≥n (Direcci√≥n o Punto de Encuentro)</label>
              <input type="text" id="ubicacion" name="ubicacion" required />
            </div>

            <!-- DESCRIPCI√ìN -->
            <div class="form-group full-width">
              <label for="descripcion">Descripci√≥n Detallada</label>
              <textarea id="descripcion" name="descripcion" rows="6" required></textarea>
            </div>
            
            <!-- IMAGEN -->
            <div class="form-group full-width">
              <label for="imagen">Imagen Principal</label>
              <input type="file" id="imagen" name="imagen" accept="image/*" />
              <p class="help-text">
                Solo sube un nuevo archivo si deseas reemplazar la imagen actual.
              </p>
            </div>

          </fieldset>
          
          <!-- FIELDSET 2: DETALLES DE RESERVA -->
          <fieldset class="form-section">
            <legend>Detalles de Reserva y Log√≠stica</legend>

            <!-- Grid for small inputs -->
            <div class="form-grid">
              <!-- DURACI√ìN -->
              <div class="form-group">
                <label for="duracion">Duraci√≥n Estimada (Horas)</label>
                <input type="number" id="duracion" name="duracion" min="0.5" step="0.5" required />
              </div>

              <!-- CAPACIDAD -->
              <div class="form-group">
                <label for="capacidad">Capacidad M√°xima</label>
                <input type="number" id="capacidad" name="capacidad" min="1" required />
              </div>

              <!-- PRECIO -->
              <div class="form-group">
                <label for="precio">Precio por Persona (USD)</label>
                <input type="number" id="precio" name="precio" min="0" step="0.01" required />
              </div>

              <!-- FECHA DEL EVENTO -->
              <div class="form-group">
                <label for="fecha_evento">Fecha y Hora</label>
                <input type="datetime-local" id="fecha_evento" name="fecha_evento" required />
              </div>
            </div>
          </fieldset>

          <div class="form-buttons" style="display: flex; gap: 10px;">
            <button type="submit" class="submit-button" style="flex: 1;">
              Guardar Cambios y Actualizar ‚úÖ
            </button>
            <button type="button" id="deleteBtn" class="submit-button" style="flex: 1; background-color: #dc3545;">
              Eliminar Experiencia üóëÔ∏è
            </button>
          </div>
        </form>

        <script>
          // Get experience ID from URL parameter
          const params = new URLSearchParams(window.location.search);
          const experienciaId = params.get('id');

          if (!experienciaId) {
            alert('ID de experiencia no proporcionado');
            window.location.href = '/experiencias';
          }

          // Load experience data on page load
          async function cargarExperiencia() {
            try {
              const response = await fetch(`/api/experiencias/${experienciaId}`);
              const data = await response.json();

              if (response.ok) {
                document.getElementById('titulo').value = data.titulo;
                document.getElementById('ubicacion').value = data.ubicacion;
                document.getElementById('descripcion').value = data.descripcion;
                document.getElementById('duracion').value = data.duracion_horas;
                document.getElementById('capacidad').value = data.capacidad_maxima;
                document.getElementById('precio').value = data.precio_por_persona;
                
                const fechaObj = new Date(data.fecha_evento);
                const fechaFormato = fechaObj.toISOString().slice(0, 16);
                document.getElementById('fecha_evento').value = fechaFormato;
              } else {
                alert('No se pudo cargar la experiencia: ' + data.error);
                window.location.href = '/experiencias';
              }
            } catch (error) {
              alert('Error al cargar: ' + error.message);
              window.location.href = '/experiencias';
            }
          }

          // Handle form submission (update)
          document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(document.getElementById('editForm'));
            
            try {
              const response = await fetch(`/api/experiencias/${experienciaId}`, {
                method: 'PUT',
                body: formData
              });
              
              const data = await response.json();
              
              if (response.ok) {
                alert('¬°Experiencia actualizada exitosamente!');
                window.location.href = '/experiencias';
              } else {
                alert(`Error: ${data.error || 'No se pudo actualizar la experiencia'}`);
              }
            } catch (error) {
              alert('Error al actualizar: ' + error.message);
            }
          });

          // Handle delete button
          document.getElementById('deleteBtn').addEventListener('click', async () => {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar esta experiencia? Esta acci√≥n no se puede deshacer.')) {
              return;
            }

            try {
              const response = await fetch(`/api/experiencias/${experienciaId}`, {
                method: 'DELETE'
              });
              
              const data = await response.json();
              
              if (response.ok) {
                alert('Experiencia eliminada exitosamente');
                window.location.href = '/experiencias';
              } else {
                alert(`Error: ${data.error || 'No se pudo eliminar la experiencia'}`);
              }
            } catch (error) {
              alert('Error al eliminar: ' + error.message);
            }
          });

          // Load experience data when page loads
          window.addEventListener('DOMContentLoaded', cargarExperiencia);
        </script>
      </section>
    </main>

    <div id="footer-placeholder"></div>
    <script src="/static/js/footer.js"></script>
    
  </body>
</html>